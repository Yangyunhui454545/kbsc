<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/review.css">
  <title>리뷰 페이지</title>
</head>
<body>
<div id="wrap">
  <header>
    <button class="go-prev">&lt;</button>
    <h1 th:text="${item.name}" class="title"></h1>
  </header>
  <div class="rate-row">
    <div class="star-rate"></div>
    <div class="num-rate"></div>
  </div>
  <div class="rate-info-row">
    <p class="rate-count"></p>
<!--    <button class="rate-btn-high"></button>-->
<!--    <button class="rate-btn-low"></button>-->
<!--    <button class="rate-btn-recent"></button>-->
  </div>
  <div class="btn-container">
    <!-- 세로 버튼바 들어가는 자리 -->
  </div>
  <div class="review-container">

  </div>
</div>

<script src="/js/createBtnContainer.js"></script>
<script>
  const rateList = [];
  const rateObject = {};
  let totalRateCount = 0;
  const url = location.pathname.split('/')[2];

  fetch(`/dev/item/${url}/review`)
          .then(res => res.text())
          .then(data => {
            console.log(data);
            data = JSON.parse(data);

            /* 상품 정보 넘어온 다음에 수정 필요한 부분! */
            // const item_id = /*[[ ${item.id} ]]*/;
            // const item_name = /*[[ ${item.name} ]]*/;
            // const item_isTestable = /*[[ ${item.is_testable} ]]*/;
            // document.querySelector('.title').textContent = item_name;
            let id = '';
            let j = 0;
            let k = 0;
            const imgList = [];

            for (let i=0; i<=(Object.keys(data).length +1);i++) {
              rateList.push(data.Review[i].rate);
              id = data.Review[i].reviewId;

              rateObject[id] = {
                index: j++,
                rate: data.Review[i].rate,
                text: data.Review[i].content,
                date: data.Review[i].date
              };
              totalRateCount++;

              imgList[k++] = data.Review[i].image;
            }

            const avgRate = (rateList.reduce((a, x) => a += x)) / totalRateCount;
            const goPrevBtn = document.querySelector('.go-prev');
            goPrevBtn.addEventListener('click', () => history.back());

            // const btnContainer = document.querySelector('.btn-container');
            // createBtnContainer(item_id, item_isTestable).forEach(el =>
            //         btnContainer.appendChild(el));

            const starMaker = rate => {
              if (rate < 2) return '⭐';
              else if (rate < 3) return '⭐⭐';
              else if (rate < 4) return '⭐⭐⭐';
              else if (rate < 5) return '⭐⭐⭐⭐';
              else return '⭐⭐⭐⭐⭐';
            }

            const rateRowStarRate = document.querySelector('.rate-row > .star-rate');
            rateRowStarRate.textContent = starMaker(avgRate);
            const rateRowNumRate = document.querySelector('.rate-row > .num-rate');
            rateRowNumRate.innerHTML = `${avgRate.toFixed(1)} <span class="light-color"> / 5<sub class="little-size">점</sub></span>`;

            const rateCount = document.querySelector('.rate-count');
            rateCount.textContent = `총 ${rateList.length} 건`;


            console.log(imgList);

            const createRateRow = review_id => {
              const reviewRow = document.createElement('div');
              reviewRow.classList.add('review-row');

              const reviewInfo = document.createElement('div');
              reviewInfo.classList.add('review-info');

              const starRate = document.createElement('div');
              starRate.classList.add('star-rate');
              /* 나중에 별 넣기 */
              starRate.textContent = starMaker(rateObject[review_id].rate);
              const numRate = document.createElement('div');
              numRate.classList.add('num-rate');
              numRate.textContent = `${rateObject[review_id].rate}점`;

              reviewInfo.appendChild(starRate);
              reviewInfo.appendChild(numRate);

              const reviewContent = document.createElement('div');
              reviewContent.classList.add('review-content');

              const reviewText = document.createElement('p');
              reviewText.classList.add('review-text');
              reviewText.textContent = rateObject[review_id].text;

              reviewContent.appendChild(reviewText);

              if (imgList[rateObject[review_id].index]) {
                const reviewImgContainer = document.createElement('div');
                reviewImgContainer.classList.add('review-img-container');

                const reviewImg = document.createElement('img');
                reviewImg.classList.add('review-img');
                reviewImg.src = imgList[rateObject[review_id].index];

                reviewImgContainer.appendChild(reviewImg);

                reviewContent.appendChild(reviewImgContainer);
              }

              const reviewDate = document.createElement('p');
              reviewDate.classList.add('review-date');

              const dateText = rateObject[review_id].date.split('T')[0].replace(/-/gi, '. ');
              reviewDate.textContent = dateText;

              reviewContent.appendChild(reviewDate);

              reviewRow.appendChild(reviewInfo);
              reviewRow.appendChild(reviewContent);

              return reviewRow;
            };

            const reviewElList = [];
            for (const [k, v] of Object.entries(rateObject)) {
              reviewElList.push(createRateRow(k));
            }

            const reviewContainer = document.querySelector('.review-container');
            reviewElList.forEach(review => {
              reviewContainer.appendChild(review);
            });


          })




</script>
</body>
</html>